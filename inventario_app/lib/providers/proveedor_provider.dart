import 'package:flutter/material.dart';
import '../models/proveedor.dart';
import '../services/api_service_jwt.dart';

class ProveedorProvider with ChangeNotifier {
  List<Proveedor> _proveedores = [];
  bool _isLoading = false;
  String? _error;

  List<Proveedor> get proveedores => _proveedores;
  bool get isLoading => _isLoading;
  String? get error => _error;

  Future<void> loadProveedores() async {
    print('üîÑ ProveedorProvider: Iniciando carga de proveedores...');
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _proveedores = await ApiServiceJWT.handleListRequest(
        ApiServiceJWT.get('/proveedores/'),
        (json) => Proveedor.fromJson(json),
      );
      print('‚úÖ ProveedorProvider: ${_proveedores.length} proveedores cargados');
    } catch (e) {
      _error = 'Error de conexi√≥n: $e';
      print('‚ùå ProveedorProvider Exception: $_error');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> createProveedor(Proveedor proveedor) async {
    print('üîÑ ProveedorProvider: Creando proveedor: ${proveedor.nombre}');
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final newProveedor = await ApiServiceJWT.handleRequest(
        ApiServiceJWT.post('/proveedores/', proveedor.toJson()),
        (json) => Proveedor.fromJson(json),
      );
      _proveedores.add(newProveedor);
      print('‚úÖ ProveedorProvider: Proveedor creado con ID: ${newProveedor.id}');
      notifyListeners();
      return true;
    } catch (e) {
      _error = 'Error de conexi√≥n: $e';
      print('‚ùå ProveedorProvider Exception: $_error');
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
    }
  }

  Future<bool> updateProveedor(Proveedor proveedor) async {
    print('üîÑ ProveedorProvider: Actualizando proveedor ID: ${proveedor.id}');
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final updatedProveedor = await ApiServiceJWT.handleRequest(
        ApiServiceJWT.put('/proveedores/${proveedor.id}/', proveedor.toJson()),
        (json) => Proveedor.fromJson(json),
      );
      final index = _proveedores.indexWhere((p) => p.id == proveedor.id);
      if (index != -1) {
        _proveedores[index] = updatedProveedor;
        print('‚úÖ ProveedorProvider: Proveedor actualizado');
        notifyListeners();
      }
      return true;
    } catch (e) {
      _error = 'Error de conexi√≥n: $e';
      print('‚ùå ProveedorProvider Exception: $_error');
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
    }
  }

  Future<bool> deleteProveedor(int id) async {
    print('üîÑ ProveedorProvider: Eliminando proveedor ID: $id');
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final response = await ApiServiceJWT.delete('/proveedores/$id/');
      if (response.statusCode >= 200 && response.statusCode < 300) {
        _proveedores.removeWhere((proveedor) => proveedor.id == id);
        print('‚úÖ ProveedorProvider: Proveedor eliminado');
        notifyListeners();
        return true;
      } else {
        _error = 'Error al eliminar proveedor';
        print('‚ùå ProveedorProvider: ${_error}');
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = 'Error de conexi√≥n: $e';
      print('‚ùå ProveedorProvider Exception: $_error');
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
    }
  }

  void clearError() {
    _error = null;
    notifyListeners();
  }

  void clearProveedores() {
    _proveedores.clear();
    notifyListeners();
  }
}
